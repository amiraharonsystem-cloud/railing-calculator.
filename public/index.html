async function syncWithGoogleSheets() {
    const tester = document.getElementById('testerSelect').value;
    const selector = document.getElementById('scheduleSelect');
    
    if (!tester) return;
    selector.innerHTML = '<option>טוען נתונים מהלו"ז...</option>';

    // לוגיקה חכמה: מחלץ שם פרטי כדי למנוע בעיות של ו' חסרה/מיותרת
    const firstName = tester.split(' ')[0]; 

    let foundProjects = [];

    for (let gid of TAB_GIDS) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
            const res = await fetch(url);
            const csvData = await res.text();
            const rows = csvData.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));

            rows.forEach((row) => {
                const rowText = row.join(' ');
                
                // חיפוש לפי שם פרטי והתעלמות מביטולים
                if (rowText.includes(firstName) && !rowText.includes("בוטל") && !rowText.includes("נדחה")) {
                    
                    // מציאת עמודות לפי כותרות או מיקום משוער
                    foundProjects.push({
                        client: row[3] || row[2] || "לא צוין", // עמודה D או C
                        address: row[4] || row[5] || "כתובת חסרה", // עמודה E או F
                        projectNum: row[1] || "", // עמודה B
                        date: gid === '689162898' ? '2026-01-18' : '2026-01-19'
                    });
                }
            });
        } catch (e) { console.error("Error fetching tab:", gid); }
    }

    selector.innerHTML = '<option value="">-- בחר פרויקט --</option>';
    if (foundProjects.length === 0) {
        selector.innerHTML = '<option>אין עבודות משובצות ל' + firstName + '</option>';
    } else {
        foundProjects.forEach((p, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = `${p.date.split('-').reverse().join('.')} | ${p.client} - ${p.address}`;
            opt.dataset.full = JSON.stringify(p);
            selector.appendChild(opt);
        });
    }
}
