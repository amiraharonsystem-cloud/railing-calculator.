<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת בדיקת מעקות - ת"י 1142</title>
    <style>
        :root { --primary: #1a237e; --accent: #fbc02d; --success: #2e7d32; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 6px solid var(--primary); }
        
        .header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .header h1 { color: var(--primary); margin: 0; font-size: 24px; }
        
        .setup-box { background: #fffde7; border: 2px solid var(--accent); padding: 15px; border-radius: 8px; margin-bottom: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        
        .section { margin-bottom: 20px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .section-header { background: var(--primary); color: white; padding: 10px 15px; font-weight: bold; font-size: 16px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 15px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 13px; font-weight: bold; margin-bottom: 5px; color: #444; }
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #f8f9fa; color: var(--primary); font-size: 13px; }
        
        .num-in { width: 80px; text-align: center; font-weight: bold; background: #fff9c4; border: 1px solid #ffd54f; border-radius: 4px; padding: 5px; }
        .readonly { background: #f1f3f4 !important; color: #666; cursor: not-allowed; }
        
        .btn-submit { background: var(--success); color: white; padding: 15px; width: 100%; border: none; border-radius: 6px; font-size: 18px; cursor: pointer; font-weight: bold; transition: 0.3s; margin-top: 10px; }
        .btn-submit:hover { background: #1b5e20; transform: translateY(-2px); }

        @media (max-width: 600px) {
            .setup-box { grid-template-columns: 1fr; }
            th, td { padding: 8px; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>דוח בדיקת מעקה - ת"י 1142</h1>
        <p>משיכת נתונים אוטומטית מלו"ז מערכות בניין</p>
    </div>

    <div class="setup-box">
        <div class="field">
            <label>1. בחר בודק:</label>
            <select id="testerSelect" onchange="syncWithSchedule()">
                <option value="">-- בחר בודק --</option>
                <option value="אמיר אהרון">אמיר אהרון</option>
                <option value="סרגיי אוסוקרקו">סרגיי אוסוקרקו</option>
                <option value="אנדריי רזיק">אנדריי רזיק</option>
            </select>
        </div>
        <div class="field">
            <label>2. פרויקט מהלו"ז (18-19.01):</label>
            <select id="scheduleSelect" onchange="autoFillForm()">
                <option value="">-- בחר בודק תחילה --</option>
            </select>
        </div>
    </div>

    <form id="mainForm">
        <div class="section">
            <div class="section-header">פרטי מנהלה</div>
            <div class="grid">
                <div class="field"><label>שם המזמין:</label><input type="text" id="clientName"></div>
                <div class="field"><label>כתובת האתר:</label><input type="text" id="siteAddr"></div>
                <div class="field"><label>מספר פרויקט:</label><input type="text" id="projId"></div>
                <div class="field"><label>תאריך בדיקה:</label><input type="date" id="testDate"></div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">סעיף 2: העמסה אופקית (חישובים אוטומטיים)</div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>שלב בדיקה</th>
                            <th>עומס (ק"ג)</th>
                            <th>תזוזה (מ"מ)</th>
                            <th>מסקנה</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>א' - מחצית עומס (107)</td>
                            <td><input type="text" id="loadHalf" class="num-in readonly" readonly></td>
                            <td><input type="number" id="distHalf" class="num-in" step="0.01" oninput="calculateTotal()"></td>
                            <td><select><option>מתאים</option><option>לא מתאים</option></select></td>
                        </tr>
                        <tr>
                            <td>א' - עומס מלא (108)</td>
                            <td><input type="number" id="loadFull" class="num-in" oninput="updateHalfLoad()"></td>
                            <td><input type="number" class="num-in" step="0.01"></td>
                            <td><select><option>מתאים</option><option>לא מתאים</option></select></td>
                        </tr>
                        <tr>
                            <td>ג' - ניצב (110)</td>
                            <td><input type="number" class="num-in"></td>
                            <td><input type="number" id="distVertical" class="num-in" step="0.01" oninput="calculateTotal()"></td>
                            <td><select><option>מתאים</option><option>לא מתאים</option></select></td>
                        </tr>
                        <tr style="background:#e8f5e9; font-weight:bold;">
                            <td colspan="2">ד' - סכום תזוזות (114)</td>
                            <td><input type="text" id="totalDist" class="num-in readonly" readonly></td>
                            <td><select><option>מתאים</option></select></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <button type="button" class="btn-submit" onclick="generateExcel()">הפק דוח אקסל</button>
    </form>
</div>

<script>
    const SHEET_ID = '1JpM_HhT-EyTclnSP12VlpaZFKZwgfHSGOS4YRPZbbvs';
    const GIDS = ['689162898', '1424845815']; // טאבים של 18 ו-19 בינואר

    async function syncWithSchedule() {
        const tester = document.getElementById('testerSelect').value;
        const selector = document.getElementById('scheduleSelect');
        if (!tester) return;

        selector.innerHTML = '<option>מחפש נתונים...</option>';
        const firstName = tester.split(' ')[0]; // חיפוש לפי שם פרטי בלבד למניעת טעויות כתיב
        let found = [];

        for (let gid of GIDS) {
            try {
                const response = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`);
                const csv = await response.text();
                const rows = csv.split('\n').map(r => r.split(',').map(c => c.replace(/"/g, '').trim()));

                rows.forEach((row, idx) => {
                    const rowText = row.join(' ');
                    // חיפוש חכם: אם השם נמצא והשורה לא מבוטלת
                    if (rowText.includes(firstName) && !rowText.includes("בוטל") && !rowText.includes("נדחה")) {
                        // בודק אם הנתונים בשורה הנוכחית או בשורות שמתחת (מבנה הלו"ז משתנה)
                        let dataRow = row;
                        if (!row[3] || row[3].length < 2) { // אם תא המזמין ריק, אולי הנתונים בשורה מתחת
                            dataRow = rows[idx + 1] || row;
                        }

                        found.push({
                            client: dataRow[3] || "לא ידוע",
                            address: dataRow[4] || dataRow[5] || "כתובת חסרה",
                            proj: dataRow[1] || "",
                            date: gid === '689162898' ? '2026-01-18' : '2026-01-19'
                        });
                    }
                });
            } catch (e) { console.error("Error fetching sheet:", e); }
        }

        selector.innerHTML = '<option value="">-- בחר פרויקט --</option>';
        if (found.length === 0) {
            selector.innerHTML = '<option>אין עבודות משובצות</option>';
        } else {
            found.forEach((p, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = `${p.date.split('-').reverse().join('.')} | ${p.client} - ${p.address}`;
                opt.dataset.full = JSON.stringify(p);
                selector.appendChild(opt);
            });
        }
    }

    function autoFillForm() {
        const sel = document.getElementById('scheduleSelect');
        const opt = sel.options[sel.selectedIndex];
        if (!opt || !opt.dataset.full) return;

        const data = JSON.parse(opt.dataset.full);
        document.getElementById('clientName').value = data.client;
        document.getElementById('siteAddr').value = data.address;
        document.getElementById('projId').value = data.proj;
        document.getElementById('testDate').value = data.date;
    }

    function updateHalfLoad() {
        const full = parseFloat(document.getElementById('loadFull').value) || 0;
        document.getElementById('loadHalf').value = (full / 2).toFixed(1);
    }

    function calculateTotal() {
        const d1 = parseFloat(document.getElementById('distHalf').value) || 0;
        const d2 = parseFloat(document.getElementById('distVertical').value) || 0;
        document.getElementById('totalDist').value = (d1 + d2).toFixed(2);
    }

    function generateExcel() {
        alert("הנתונים נאספו. פונקציית ייצוא לקובץ אקסל (XLSX) דורשת ספרייה חיצונית או שליחה לשרת.");
    }
</script>

</body>
</html>
